<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Javier  Cabrera Arteaga | How to deploy hand made Wasm code in Fastly Compute@Edge.</title>
<meta name="description" content="How to deploy your first Fastly's Compute@Edge service ? How to deploy custom Wasm to it ? ... and a little bit of metaprogramming with Rust.">

<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Styles -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/blog/2021/HandMadeWasmDeploInFastly/">

<!-- Open Graph -->

<meta property="og:site_name" content="Personal blog
How to deploy your first Fastly's Compute@Edge service ? How to deploy custom Wasm to it ? ... and a little bit of metaprogramming with Rust." />
<meta property="og:type" content="object" />
<meta property="og:title" content="How to deploy hand made Wasm code in Fastly Compute@Edge." />
<meta property="og:url" content="/blog/2021/HandMadeWasmDeploInFastly/" />
<meta name="description" property="og:description" content="How to deploy your first Fastly's Compute@Edge service ? How to deploy custom Wasm to it ? ... and a little bit of metaprogramming with Rust." />
<meta name="author" content="Javier Cabrera-Arteaga">
<meta name="image" property="og:image" content="" />


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light bg-white navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       <span class="font-weight-bold">Javier</span>   Cabrera Arteaga PhD 
      </a>
      
      <!-- Navbar Toogle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              About
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              Blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/cv/">
                CV
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/thesis/">
                Lic Thesis
                
              </a>
          </li>
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/pthesis/">
                PhD Thesis
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                Projects
                
              </a>
          </li>
          
          
          
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">How to deploy hand made Wasm code in Fastly Compute@Edge.</h1>
    <p class="post-meta">January 11, 2021</p>
  </header>

  <article class="post-content">
    <h1 id="edge-computing-and-fastly">Edge Computing and Fastly</h1>

<p><a href="https://www.fastly.com/">Fastly</a> offers a powerful edge cloud service; it brings the tools to provide apps optimized for speed and scale. Edge computing is done at or near the customer’s requests instead of relying on the cloud at one of a dozen data centers to do all the work. Literally, this has a geographic meaning. It doesn’t mean the cloud will disappear. It means the cloud is coming to you.</p>

<p>Fastly provides the way to decentralize your application’s architecture using WebAssembly that executes on the Edge, following the words from Fastly</p>

<blockquote>
  <p>Compute@Edge is a computation platform capable of running custom binaries that you compile on your own systems and upload to Fastly…</p>
</blockquote>

<p>Fastly is Rust language enthusiastic. The applications that you submit to the Compute@Edge service are WebAsembly binaries that run on top of a super performant interpreter implemented in Rust, called Lucet. Fastly also provides a Rust library for HTTP services implementation, which means that you are fully supported to implement your services in Rust and then compile them to WebAssembly.</p>

<p>Rust is a relatively new language, it is memory safe and performant. It supports the compilation of the source code to WebAssembly almost since the release of Rust’s toolchain.</p>

<p>To run your first “hello world” in Fastly Edge computing, you can follow this <a href="https://developer.fastly.com/learning/compute/">tutorial</a>. Fastly provides a CLI tool to interact with the computing edge service API, to create, delete, and deploy services. Each service is deployed as an HTTP service. When you make a deploy with the CLI tool, you submit a Wasm binary with a specific structure. I meant a particular form that the Wasm module needs, to provide all the plumbing to interact with HTTP calls and the service’s application entry point. The fastly CLI provides the boilerplate for creating a Rust project. The before mentioned infrastructure is built when it is compiled to Wasm.</p>

<p>For example, the following Rust code is all you need to deploy a service in the Compute@Edge service of Fastly.</p>

<div class="language-rs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre><span class="k">use</span> <span class="nn">fastly</span><span class="p">::</span><span class="nn">http</span><span class="p">::{</span><span class="n">HeaderValue</span><span class="p">,</span> <span class="n">Method</span><span class="p">,</span> <span class="n">StatusCode</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">fastly</span><span class="p">::</span><span class="nn">request</span><span class="p">::</span><span class="n">CacheOverride</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">fastly</span><span class="p">::{</span><span class="n">Body</span><span class="p">,</span> <span class="n">Error</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">RequestExt</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">ResponseExt</span><span class="p">};</span>

<span class="nd">#[fastly::main]</span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">(</span><span class="k">mut</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="o">&lt;</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="k">impl</span> <span class="n">ResponseExt</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="nn">Response</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
            <span class="nf">.status</span><span class="p">(</span><span class="nn">StatusCode</span><span class="p">::</span><span class="n">OK</span><span class="p">)</span>
            <span class="nf">.body</span><span class="p">(</span><span class="nn">Body</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="cm">/*Whatever*/</span><span class="p">))</span><span class="o">?</span><span class="p">)</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>All you need to do is to compile this code as <code class="language-plaintext highlighter-rouge">cargo build --target wasm32-wasi</code>.</p>

<h1 id="but-what-if--">But, what if … ?</h1>

<p>Suppose you have a Wasm binary, but you don’t have the source code for this Wasm module, or simply this Wasm module does not come from a standard compilation pipeline like the previously mentioned. It lacks the needed ABI to deal with fastly HTTP services. Thus, you cannot deploy this binary directly to the Compute@Edge service because it is not valid. On the other hand, you rely on the Rust backend to generate Wasm code, and sometimes the generated code does not have the quality that a hand-made Wasm can achieve.</p>

<p>One way to deal with this problem is to search for the functionality you want to deploy, migrate/implement it to/in Rust, and then include the <a href="https://crates.io/crates/fastly">fastly Rust crate</a>. But this is not fun <img class="emoji" title=":grin:" alt=":grin:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f601.png" height="20" width="20"> . The other way is to try to embed the Wasm binary code in the Rust code. To do so, you can use <code class="language-plaintext highlighter-rouge">asm</code> macro of Rust to directly write assembly code (depending on the target architecture).</p>

<h2 id="rust-inline-asm">Rust inline asm</h2>

<p>Rust provides a low-level manipulation macro, <a href="https://doc.rust-lang.org/nightly/unstable-book/library-features/asm.html">asm</a>. This macro allows you to write unsafe code directly, typing asm instructions inside the Rust source code. The following code shows how to use the macro to inject unsafe assembly instructions.</p>

<div class="language-rs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="k">unsafe</span> <span class="p">{</span>
    <span class="nd">asm!</span><span class="p">(</span><span class="s">"nop"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">asm</code> macro supports to write assembly instructions depending on the target of the project. The rustc compiler uses the LLVM backend behind, meaning that you can write any instructions for the LLVM backends supported by Rust. The good news is that <code class="language-plaintext highlighter-rouge">wasm32</code> is already added. The currently allowed architectures are:</p>

<ul>
  <li>x86 and x86-64</li>
  <li>ARM</li>
  <li>AArch64</li>
  <li>RISC-V</li>
  <li>NVPTX</li>
  <li>Hexagon</li>
  <li>MIPS32r2 and MIPS64r2</li>
  <li>wasm32</li>
</ul>

<p>In principle, the only thing that we need to do is create a Rust function and then add the body of the wanted Wasm module as unsafe assembly instructions, as the following listing illustrates.</p>

<div class="language-rs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td>
<td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">unsafe_wasm</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i32</span><span class="p">{</span>
    <span class="k">unsafe</span><span class="p">{</span>
        <span class="k">let</span> <span class="n">r</span><span class="p">:</span><span class="nb">i32</span><span class="p">;</span>
        <span class="nd">asm!</span><span class="p">(</span>
         <span class="s">"i32.const 42"</span><span class="p">,</span> <span class="c1">// the meaning of life</span>
         <span class="s">"local.get {}"</span><span class="p">,</span>
         <span class="nf">out</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="n">r</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="n">r</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>When we compile the code above to Wasm, we obtain the following code for the <code class="language-plaintext highlighter-rouge">unsafe_wasm</code> function.</p>

<div class="language-llvm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td>
<td class="rouge-code"><pre><span class="p">(</span><span class="err">func</span> <span class="err">$unsafe_wasm</span> <span class="p">(</span><span class="k">type</span> <span class="m">0</span><span class="p">)</span> <span class="p">(</span><span class="err">result</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="p">(</span><span class="err">local</span> <span class="kt">i32</span> <span class="kt">i32</span> <span class="kt">i32</span> <span class="kt">i32</span> <span class="kt">i32</span> <span class="kt">i32</span> <span class="kt">i32</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="k">global</span><span class="p">.</span><span class="err">get</span> <span class="m">0</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">0</span>
    <span class="kt">i32</span><span class="p">.</span><span class="err">const</span> <span class="m">16</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">1</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">0</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">1</span>
    <span class="kt">i32</span><span class="p">.</span><span class="k">sub</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">2</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">2</span>
    <span class="k">global</span><span class="p">.</span><span class="err">set</span> <span class="m">0</span> 
    <span class="kt">i32</span><span class="p">.</span><span class="err">const</span> <span class="m">42</span> <span class="c1">; Here is the code</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">3</span>  <span class="c1">; -----------------</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">3</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">4</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">2</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">4</span>
    <span class="kt">i32</span><span class="p">.</span><span class="k">store</span> <span class="k">offset</span><span class="p">=</span><span class="m">12</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">2</span>
    <span class="kt">i32</span><span class="p">.</span><span class="k">load</span> <span class="k">offset</span><span class="p">=</span><span class="m">12</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">5</span>
    <span class="kt">i32</span><span class="p">.</span><span class="err">const</span> <span class="m">16</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">6</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">2</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">6</span>
    <span class="kt">i32</span><span class="p">.</span><span class="k">add</span>
    <span class="err">local</span><span class="p">.</span><span class="err">set</span> <span class="m">7</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">7</span>
    <span class="k">global</span><span class="p">.</span><span class="err">set</span> <span class="m">0</span>
    <span class="err">local</span><span class="p">.</span><span class="err">get</span> <span class="m">5</span>
    <span class="err">return</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>We inserted 2 instructions; however, the generated code contains 29. This result is not good. We are precisely expecting what we injected. The backend injects all the plumbing to ensure that the injected code does not interfere with the service code.</p>

<h2 id="global_asm-macro">global_asm macro</h2>

<p><a href="https://rust-lang.github.io/rfcs/1548-global-asm.html">This RFC</a> exposes LLVM’s support for module-level inline assembly by adding a <code class="language-plaintext highlighter-rouge">global_asm!</code> macro.</p>

<div class="language-rs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="nd">global_asm!</span><span class="p">(</span><span class="s">r#"
    .globl my_asm_func
    my_asm_func:
        ...
"#</span><span class="p">);</span>

<span class="k">extern</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">my_asm_func</span><span class="p">();</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>
<p>The official documentation describes the motivation for this macro as follows.</p>
<blockquote>
  <p>There are two main use cases for this feature. The first is that it allows functions to be written completely in assembly, which mostly eliminates the need for a naked attribute. This is mainly useful for function that use a custom calling convention, such as interrupt handlers.</p>
</blockquote>

<blockquote>
  <p>Another important use case is that it allows external assembly files to be used in a Rust module without needing hacks in the build system:</p>
</blockquote>

<p>This means that you can declare functions directly with assembly instructions instead of writing the body in a defined Rust function. We can write WAT code now in the Rust code, and we will get this code in the final Wasm binary. However, the <code class="language-plaintext highlighter-rouge">global_asm</code> macro expects <a href="https://llvm.org/docs/MIRLangRef.html">LLVM MIR format</a>, which is slightly different from the <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format">Wat format</a>. For example, we know that blocks and loops in Wasm explicitly finish with <code class="language-plaintext highlighter-rouge">end</code> instructions. In the LLVM MIR format, the <code class="language-plaintext highlighter-rouge">end</code> instructions need to be declared with the semantic of the ending control flow; in this case, <code class="language-plaintext highlighter-rouge">end_block</code> and <code class="language-plaintext highlighter-rouge">end_loop</code>, respectively. The same phenomenon happens with the declaration of the function and the local variables. The good news is that the translation from WAT format to LLVM MIR can be done linearly.</p>

<ol>
  <li>Declare the new function with its type.</li>
  <li>Declare the locals used in the Wasm code</li>
  <li>
    <p>Replace the <code class="language-plaintext highlighter-rouge">end</code> instructions from the WAT code to the respective LLVM MIR <code class="language-plaintext highlighter-rouge">end</code> instructions.</p>

    <ol>
      <li>For example, you can use the naive algorithm of counting balanced parenthesis.</li>
    </ol>
  </li>
  <li>Copy the transformed code to the body of the function in the LLVM MIR format.</li>
  <li>Close the function with the <code class="language-plaintext highlighter-rouge">end_function</code>  instruction.</li>
</ol>

<p>Lets suppose that we want a function that returns the meaning of life and everything, <code class="language-plaintext highlighter-rouge">42</code>. In the LLVM MIR format for WebAssembly it should look like.</p>

<div class="language-llvm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre>    <span class="p">.</span><span class="k">type</span>	<span class="err">life</span><span class="p">,</span><span class="vg">@function</span>
        <span class="nl">life:</span>
    <span class="p">.</span><span class="err">functype</span>	<span class="err">life</span> <span class="p">()</span> <span class="err">-</span><span class="p">&gt;</span> <span class="p">(</span><span class="kt">i32</span><span class="p">)</span>
    <span class="p">.</span><span class="err">local</span> <span class="kt">i32</span>
        <span class="kt">i32</span><span class="p">.</span><span class="err">const</span> <span class="m">42</span>
    <span class="err">end_function</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>This code is injected in the compiled service Wasm exactly as it is written before. Check the Wasm code below.</p>

<div class="language-llvm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="p">(</span><span class="err">func</span> <span class="err">$life</span> <span class="p">(</span><span class="k">type</span> <span class="m">0</span><span class="p">)</span> <span class="p">(</span><span class="err">result</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="p">(</span><span class="err">local</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="kt">i32</span><span class="p">.</span><span class="err">const</span> <span class="m">42</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h1 id="putting-all-together">Putting all together</h1>

<p>Lets put all together in our new service. This code can be compiled to <code class="language-plaintext highlighter-rouge">wasm32-wasi</code> and then submitted to the Fastly Compute@Edge service.</p>

<div class="language-rs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td>
<td class="rouge-code"><pre><span class="nd">#![feature(asm)]</span>
<span class="nd">#![feature(global_asm)]</span>

<span class="k">use</span> <span class="nn">fastly</span><span class="p">::</span><span class="nn">http</span><span class="p">::{</span><span class="n">HeaderValue</span><span class="p">,</span> <span class="n">Method</span><span class="p">,</span> <span class="n">StatusCode</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">fastly</span><span class="p">::</span><span class="nn">request</span><span class="p">::</span><span class="n">CacheOverride</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">fastly</span><span class="p">::{</span><span class="n">Body</span><span class="p">,</span> <span class="n">Error</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">RequestExt</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">ResponseExt</span><span class="p">};</span>

<span class="nd">#[fastly::main]</span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">(</span><span class="k">mut</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="o">&lt;</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="k">impl</span> <span class="n">ResponseExt</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="nn">Response</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
            <span class="nf">.status</span><span class="p">(</span><span class="nn">StatusCode</span><span class="p">::</span><span class="n">OK</span><span class="p">)</span>
            <span class="nf">.body</span><span class="p">(</span><span class="nn">Body</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="k">unsafe</span> <span class="p">{</span>
                <span class="nf">life</span><span class="p">()</span>
            <span class="p">}</span><span class="nf">.to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">global_asm!</span><span class="p">(</span><span class="s">r#"
    .type	life,@function
        life:
    .functype	life () -&gt; (i32)
        i32.const 42
    end_function
"#</span><span class="p">);</span>

<span class="k">extern</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">life</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i32</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'jacarte-github-io';
      var disqus_identifier = '/blog/2021/HandMadeWasmDeploInFastly';
      var disqus_title      = "How to deploy hand made Wasm code in Fastly Compute@Edge.";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    © Copyright 2024 Javier  Cabrera Arteaga.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>
</footer>



  </body>

  <!-- Load Core and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha512-/DXTXr6nQodMUiq+IUJYCt2PPOUjrHJ9wFrqpJ3XkgPNOZVfMok7cRw6CSxyCQxXn6ozlESsSh1/sMCTF1rL/g==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"  integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/.css" />


<!-- Load KaTeX -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
<script src="/assets/js/katex.js"></script>



<!-- Load Mansory & imagesLoaded -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js" integrity="" crossorigin="anonymous"></script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>

<!-- Project Cards Layout -->
<script type="text/javascript">
  // Init Masonry
  var $grid = $('.grid').masonry({
    gutter: 10,
    horizontalOrder: true,
    itemSelector: '.grid-item',
  });
  // layout Masonry after each image loads
  $grid.imagesLoaded().progress( function() {
    $grid.masonry('layout');
  });
</script>



<!-- Enable Tooltips -->
<script type="text/javascript">
$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})
</script>



<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-127898106-1', 'auto');
ga('send', 'pageview');
</script>



</html>
